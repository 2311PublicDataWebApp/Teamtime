<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	<head th:replace="layout/head::header"></head>
	<body id="page-top">
		<th:block sec:authorize="isAuthenticated()">
		    <!-- Page Wrapper -->
		    <div id="wrapper">
		    	<div th:replace="layout/sidebar::sidebar"></div>
		        <!-- Content Wrapper -->
		        <div id="content-wrapper" class="d-flex flex-column">
		            <!-- Main Content -->
		            <div id="content">
		                <div th:replace="layout/topbar::topbar"></div>
		                <!-- Begin Page Content -->
		                <div class="container-fluid">
			                <div class="d-sm-flex align-items-center justify-content-between mb-4">
		                        <h1 class="h3 mb-0 text-gray-800" th:text="${room.roomName}"></h1>
		                    </div>
				            <div class="row">
				                <div class="col-6"></div>
				                <div id="msgArea" class="col-6"></div>
				            </div>
		                    <div class="input-group mb-3">
		                        <input type="text" id="msg" class="form-control">
		                        <div class="input-group-append">
		                            <button class="btn btn-outline-secondary" type="button" id="button-send">전송</button>
		                        </div>
		                    </div>
				        </div>
		            <!-- End of Main Content -->
		            <div th:replace="layout/footer::footer"></div>
		        </div>
		        <!-- End of Content Wrapper -->
		    </div>
		    <!-- End of Page Wrapper -->
		    <!-- Scroll to Top Button-->
		    <a class="scroll-to-top rounded" href="#page-top">
		        <i class="fas fa-angle-up"></i>
		    </a>
		    </div>
	   	</th:block>
		<script th:inline="javascript">
			$(document).ready(function() {
				var roomId	 = [[${room.roomId}]];
				var roomName = [[${room.roomName}]];
				var userName = [[${#authentication.principal.username}]];

				console.log(roomName + ", " + roomId + ", " + userName);

                var sockJs = new SockJS("/stomp/chat");
				// 1. SockJS를 내부에 들고있는 stomp를 내어줌
				var stomp = Stomp.over(sockJs);

				$("#button-send").on("click", function(e){
					var msg = document.getElementById("msg");
                    console.log(userName + ":" + msg.value);
                    stomp.send('/pub/chat/message', {}, JSON.stringify({roomId : roomId, writer : userName, message : msg.value}));
                    msg.value = '';
				});
				
				// 2. connection이 맺어지면 실행
				stomp.connect({}, function (){
					console.log("STOMP Connection")

					// 4. subscribe(path, callback)으로 메세지를 받을 수 있음
					stomp.subscribe("/sub/chat/room/" + roomId, function(chat) {
                        var content = JSON.parse(chat.body);
                        var writer = content.writer;
                        var message = content.message;
                        var str = '';

						if (writer === userName) {
                            str = "<div>";
                            str += "<div class='alert alert-secondary'>";
                            str += "<b>" + writer + " : " + message + "</b>";
                            str += "</div></div>";
                            $("#msgArea").append(str);
                       } else {
							str = "<div>";
                            str += "<div class='alert alert-warning'>";
                            str += "<b>" + writer + " : " + message + "</b>";
                            str += "</div></div>";
                            $("#msgArea").append(str);
						}
					});

					// 3. send(path, header, message)로 메세지를 보낼 수 있음
					stomp.send('/pub/chat/enter', {}, JSON.stringify({roomId : roomId, writer : userName}))
                });

			});
        </script>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	</body>
</html>